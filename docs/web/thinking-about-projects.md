# 项目优化以及最佳实践

优化核心点：**资源加载问题**、**文件大小问题**、**代码逻辑问题**、**交互体验问题**

优化思考：性能优化存在利于弊，需要根据实际情况进行权衡，最终要看实际的效果如何

优化流程：从核心点出发，先分析**性能瓶颈**，再定**优化指标**。最后思考**系统性解决性能问题的方案**，低成本运用到其他项目上

性能分析手段：devTools > performance，查看执行脚本、渲染、绘制执行时间，render 下查看重排重绘情况

## 资源加载

-   按需引用

    -   页面中使用 echarts，只引入所需要的图表组件

    -   使用 lodash 的方法需引入对应的源文件 js，不能使用`named import`，否则会打包整个 lodash 库！ ps：lodash-es 支持 tree shaking

    -   使用`import()`动态加载一些较大的资源，如富文本、组件，能够较大程度减小项目体积！

-   加载 SVG

    -   DataURI：采用`url-loader`插件将小图转为 base64 编码（比源文件大 1/3 左右），以避免额外的 http 请求，转化后的资源同样可用于 css `url()` ps: `vite`已默认使用此配置

    -   精灵图：采用 webpack 插件 `svg-sprite-loader`将多个 svg 合成`svg symbols`，减少了 HTTP 请求次数，需要注意`svg symbols`大小

    -   svgo：

        -   精简压缩文本中的无用信息，对于向量编辑器导出的 SVG 文件能压缩 70%左右！

        -   同时可以设置`fill: currentColor`属性，颜色跟随父元素的 color 值变化

-   资源拆分 - _合理利用 http 缓存，采用 webpack 的`splitChunks`_

    -   提取公共库文件为`libs.js`，好处在于只要不升级基础库的版本，缓存就不会被更新。**长缓存**

    -   提取公共库中 ui 库为`*-ui.js`，因为 ui 库通常体积很大。 **长缓存**

    -   从业务中提取公共部分，放到 `common.js` 中。项目里提取了`components`。 **短缓存**

        -   `minChunks`，表示文件要被提取出来时需要在指定的 Chunks 中最小出现次数

        -   `minChunks`越小越多的文件会被提取到  `common.js`  中去，但这也会导致部分页面加载的不相关的资源越多

        -   `minChunks`越大越少的文件会被提取到  `common.js`  中去，但这会导致  `common.js`  变小、效果变弱

-   CDN 加速：利用内容分发网络提高访问速度。 ps: `webpack`使用来自 JavaScript 运行环境提供的全局变量（如`jQuery`），需配置 如 `externals`，避免全局变量被打包进多个 chunk 中。

-   预加载： `preload` 指定 js、css 资源在页面生命周期早期就开始加载，最大限度同时 解析文档 和 下载资源

-   _升级到 HTTP/2，单条连接多路复用 👍。以前我们做的性能优化不适用于 HTTP/2 了，如文件合并，多域名方案。优化思路可以由减少请求数量转变增加缓存命中。_

## 资源压缩

-   JavaScript 压缩，丑化代码、删除无用的输出和注释

-   CSS 压缩，语义压缩、空格压缩

-   GZIP：对 大于 10KB 的文本资源进行压缩，资源可以压缩到比源文件小好几倍！ps：对非文本资源不适用~

-   ~~图片的压缩要参考 ui 的意见，不能盲目压缩~~

## 代码逻辑

-   组件的使用

    -   根据组件使用频率判断全局引用或者局部引用

    -   弹窗组件 - 在文档之外渲染组件，将实例挂载到全局，并通过单例模式引用

-   web worker：进行一些复杂的计算，如下载表格

-   重构代码：使用良好的设计模式，迁移到更好的技术栈

-   减少重排重绘：提高网页的响应速度和用户体验，如针对动画元素使用`translateZ()`创建 layer

-   事件代理：利用事件冒泡机制，既能节省事件监听数，也能防止操作子节点丢失事件

-   性能更好的 API

    -   IntersectionObserver：可以基于此 API 实现一个滚动加载列表，和图片的懒加载功能

    -   RequestAnimationFrame：可以实现更流畅的动画效果，且离开页面时动画会暂停

## 交互体验

-   响应式设计：确保页面在不同设备上都能良好展示

-   缓存页面：离开页面后保持页面的活性，有更好的查看体验

    交互动画：增加页面的趣味性和吸引力

-   移动 web 适配

    -   采用`px-to-viewport`适配不同的视口大小

    -   采用`autoprefixer`适配设备 css 兼容性

    -   采用 ios 提供的 api 做安全区适配，让用户操作避开底部黑线条

## 开发体验 - 不属于优化，但是好的实践

-   使用 nodejs 获取 icons 文件夹并创建图片展示页面，快速查看并复制引用

-   在线 mock：在后端接口进度落后的情况下，依然可以协同工作。可以先定义好接口数据结构，使用简单方便
